<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人間ビームシューター</title>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: black;
        }
        #gameCanvas {
            border: 1px solid white;
        }
        // ... existing styles ...

        /* Updated styles for mobile buttons */
        .mobile-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
            padding: 0 10px;
            box-sizing: border-box;
        }
        .mobile-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            color: white;
            display: none;
            position: absolute;
            bottom: 20px;
        }
        #yellowBeamBtn {
            background-color: yellow;
            color: black;
            left: 10px;
        }
        #blueBeamBtn {
            background-color: cyan;
            right: 10px;
        }
        @media (max-width: 768px) {
            .mobile-button {
                display: block;
            }
        }
        
        /* Styles for reload button */
        #reloadBtn {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #reloadBtn:hover {
            background-color: #45a049;
        }

        #lives {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: red;
        }

        #pauseOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 48px;
            z-index: 10;
        }
        #pauseMessage {
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Add this audio element just after the opening body tag -->
    <audio id="backgroundMusic" loop>
        <source src="15. Underground (Fast).mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <button id="reloadBtn">Reload Game</button>
    <div id="lives">❤❤❤</div>
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <div class="mobile-controls">
        <button id="yellowBeamBtn" class="mobile-button">Y</button>
        <button id="blueBeamBtn" class="mobile-button">B</button>
    </div>
    <div id="pauseOverlay">
        <div id="pauseMessage">
            一時停止中<br>
            Hキーで再開
        </div>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // プレイヤー
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 50,
            width: 30,
            height: 50,
            speed: 3
        };

        // 敵
        const enemies = [];
        for (let i = 0; i < 5; i++) {
            enemies.push({
                x: i * 70 + 50,
                y: 50,
                width: 30,
                height: 30,
                speed: 0.5
            });
        }

        // ビーム
        const beams = [];

        // ゲーム状態
        let gameOver = false;
        let yellowBeamRate = 10;
        let yellowBeamCounter = 0;
        let blueBeamRate = 20;
        let blueBeamCounter = 0;

        // キー入力
        const keys = {};

        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (e.code === 'KeyS') {
                togglePause();
            } else if (e.code === 'KeyH' && isPaused) {
                togglePause();
            }
            
            // Start background music on first user interaction if it's not already playing
            if (backgroundMusic.paused) {
                startBackgroundMusic();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        // Add touch event listeners for mobile buttons
        const yellowBeamBtn = document.getElementById('yellowBeamBtn');
        const blueBeamBtn = document.getElementById('blueBeamBtn');

        yellowBeamBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys['Space'] = true;
        });

        yellowBeamBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys['Space'] = false;
        });

        blueBeamBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys['KeyB'] = true;
        });

        blueBeamBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys['KeyB'] = false;
        });

        // Add touch events for player movement
        let touchStartX = 0;
        canvas.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touchX = e.touches[0].clientX;
            const diffX = touchX - touchStartX;
            
            if (diffX > 0) {
                keys['ArrowRight'] = true;
                keys['ArrowLeft'] = false;
            } else if (diffX < 0) {
                keys['ArrowLeft'] = true;
                keys['ArrowRight'] = false;
            }
            
            touchStartX = touchX;
        });

        canvas.addEventListener('touchend', () => {
            keys['ArrowLeft'] = false;
            keys['ArrowRight'] = false;
        });

        const mushrooms = [];
        let powerUpTimer = 0;
        const POWER_UP_DURATION = 300; // 5秒間（60FPS想定）

        function fireYellowBeam() {
            if (!gameOver) {
                beams.push({
                    x: player.x + player.width / 2,
                    y: player.y,
                    width: 2,
                    height: powerUpTimer > 0 ? 40 : 20, // パワーアップ時にビームを長くする
                    speed: powerUpTimer > 0 ? 30 : 4,
                    color: 'yellow',
                    dx: 0
                });
            }
        }

        function fireBlueBeams() {
            if (!gameOver) {
                // 左の青いビーム
                beams.push({
                    x: player.x,
                    y: player.y + player.height * 0.3,
                    width: 2,
                    height: powerUpTimer > 0 ? 30 : 15, // パワーアップ時にビームを長くする
                    speed: powerUpTimer > 0 ? 24 : 3,
                    color: 'cyan',
                    dx: -0.5
                });
                // 右の青いビーム
                beams.push({
                    x: player.x + player.width,
                    y: player.y + player.height * 0.3,
                    width: 2,
                    height: powerUpTimer > 0 ? 30 : 15, // パワーアップ時にビームを長くする
                    speed: powerUpTimer > 0 ? 24 : 3,
                    color: 'cyan',
                    dx: 0.5
                });
            }
        }

        let level = 1;
        let lives = 3;
        const enemyBullets = [];

        function fireEnemyBullet() {
            if (enemies.length > 0 && Math.random() < 0.02) {
                const shooter = enemies[Math.floor(Math.random() * enemies.length)];
                enemyBullets.push({
                    x: shooter.x + shooter.width / 2,
                    y: shooter.y + shooter.height,
                    width: 2,
                    height: 10,
                    speed: 1.5, // 速度を3から1.5に減少
                    color: 'red'
                });
            }
        }

        function updateLives() {
            document.getElementById('lives').innerHTML = '❤'.repeat(lives);
        }

        function resetGame() {
            enemies.length = 0;
            beams.length = 0;
            enemyBullets.length = 0;
            player.x = canvas.width / 2;
            player.y = canvas.height - 50;

            for (let i = 0; i < 5; i++) {
                enemies.push({
                    x: i * 70 + 50,
                    y: 50,
                    width: 30,
                    height: 30,
                    speed: 0.5 + (level * 0.1)
                });
            }

            gameOver = false;
            lives = 3;
            updateLives();

            // Start the background music if it's not already playing
            if (backgroundMusic.paused) {
                startBackgroundMusic();
            }
        }

        let isPaused = false;

        function togglePause() {
            isPaused = !isPaused;
            const pauseOverlay = document.getElementById('pauseOverlay');
            pauseOverlay.style.display = isPaused ? 'flex' : 'none';
            
            // Pause or resume the background music
            if (isPaused) {
                backgroundMusic.pause();
            } else {
                backgroundMusic.play().catch(error => {
                    console.log("Audio play failed:", error);
                });
            }
        }

        function spawnMushroom() {
            if (Math.random() < 0.0005) { // 0.5%の確率できのこを生成
                mushrooms.push({
                    x: Math.random() * (canvas.width - 20),
                    y: 0,
                    width: 20,
                    height: 20,
                    speed: 2
                });
            }
        }

        function update() {
            if (gameOver) {
                stopBackgroundMusic();
                return;
            }
            if (isPaused) return;

            // プレイヤーの移動
            if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
            if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += player.speed;

            // 黄色いビームの発射処理
            if (keys['Space']) {
                yellowBeamCounter++;
                if (yellowBeamCounter >= yellowBeamRate) {
                    fireYellowBeam();
                    yellowBeamCounter = 0;
                }
            } else {
                yellowBeamCounter = yellowBeamRate;
            }

            // 青いビームの発射処理
            if (keys['KeyB']) {
                blueBeamCounter++;
                if (blueBeamCounter >= blueBeamRate) {
                    fireBlueBeams();
                    blueBeamCounter = 0;
                }
            } else {
                blueBeamCounter = blueBeamRate;
            }

            // 敵の移動
            enemies.forEach(enemy => {
                enemy.x += enemy.speed;
                if (enemy.x <= 0 || enemy.x >= canvas.width - enemy.width) {
                    enemy.speed *= -1;
                    enemy.y += 10;
                }
            });

            // ビームの移動と当たり判定
            beams.forEach((beam, beamIndex) => {
                beam.y -= beam.speed;
                beam.x += beam.dx;
                if (beam.y + beam.height < 0 || beam.x < 0 || beam.x > canvas.width) {
                    beams.splice(beamIndex, 1);
                    return;
                }

                enemies.forEach((enemy, enemyIndex) => {
                    if (
                        beam.x < enemy.x + enemy.width &&
                        beam.x + beam.width > enemy.x &&
                        beam.y < enemy.y + enemy.height &&
                        beam.y + beam.height > enemy.y
                    ) {
                        enemies.splice(enemyIndex, 1);
                        beams.splice(beamIndex, 1);
                    }
                });
            });

            // 敵の弾の処理
            fireEnemyBullet();
            enemyBullets.forEach((bullet, index) => {
                bullet.y += bullet.speed;
                if (bullet.y > canvas.height) {
                    enemyBullets.splice(index, 1);
                } else if (
                    bullet.x < player.x + player.width &&
                    bullet.x + bullet.width > player.x &&
                    bullet.y < player.y + player.height &&
                    bullet.y + bullet.height > player.y
                ) {
                    lives--;
                    updateLives();
                    enemyBullets.splice(index, 1);
                    if (lives <= 0) {
                        gameOver = true;
                    }
                }
            });

            // ゲームクリア判定
            if (enemies.length === 0) {
                level++;
                resetGame();
                // Don't restart the music here, it should continue playing
            }

            // ビームの発射レートを下げる（間隔を長くす���）
            yellowBeamRate = 20; // 5から20に増加（より少ない頻度で発射）
            blueBeamRate = 40; // 10から40に増加（より少ない頻度で発射）

            // きのこの更新
            spawnMushroom();
            mushrooms.forEach((mushroom, index) => {
                mushroom.y += mushroom.speed;
                if (mushroom.y > canvas.height) {
                    mushrooms.splice(index, 1);
                } else if (
                    player.x < mushroom.x + mushroom.width &&
                    player.x + player.width > mushroom.x &&
                    player.y < mushroom.y + mushroom.height &&
                    player.y + player.height > mushroom.y
                ) {
                    mushrooms.splice(index, 1);
                    powerUpTimer = POWER_UP_DURATION;
                }
            });

            // パワーアップタイマーの更新
            if (powerUpTimer > 0) {
                powerUpTimer--;
            }
        }

        function drawPlayer() {
            ctx.fillStyle = 'lime';
            
            // 体
            ctx.fillRect(player.x + player.width * 0.3, player.y + player.height * 0.4, player.width * 0.4, player.height * 0.6);
            
            // 頭
            ctx.beginPath();
            ctx.arc(player.x + player.width / 2, player.y + player.height * 0.2, player.width * 0.2, 0, Math.PI * 2);
            ctx.fill();
            
            // 左腕
            ctx.fillRect(player.x, player.y + player.height * 0.3, player.width * 0.2, player.height * 0.4);
            
            // 右腕
            ctx.fillRect(player.x + player.width * 0.8, player.y + player.height * 0.3, player.width * 0.2, player.height * 0.4);
        }

        function draw() {
            if (isPaused) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // プレイヤーの描画
            drawPlayer();

            // 敵の描画
            ctx.fillStyle = 'red';
            enemies.forEach(enemy => {
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            });

            // ビームの描画
            beams.forEach(beam => {
                ctx.fillStyle = beam.color;
                ctx.fillRect(beam.x, beam.y, beam.width, beam.height);
            });

            // 敵の弾の描画
            enemyBullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            });

            // ゲームオーバー時の表示
            if (gameOver) {
                ctx.fillStyle = lives > 0 ? 'yellow' : 'red';
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(lives > 0 ? 'Level Clear!' : 'Game Over', canvas.width / 2, canvas.height / 2);
            }

            // レベル表示
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Level: ${level}`, 10, 30);

            // きのこの描画
            ctx.fillStyle = 'purple';
            mushrooms.forEach(mushroom => {
                ctx.fillRect(mushroom.x, mushroom.y, mushroom.width, mushroom.height);
            });

            // パワーアップ状態の表示
            if (powerUpTimer > 0) {
                ctx.fillStyle = 'white';
                ctx.font = '16px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('Power Up!', 10, 50);
            }
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Add reload button functionality
        const reloadBtn = document.getElementById('reloadBtn');
        reloadBtn.addEventListener('click', () => {
            location.reload();
        });

        const backgroundMusic = document.getElementById('backgroundMusic');

        function startBackgroundMusic() {
            backgroundMusic.play().catch(error => {
                console.log("Audio play failed:", error);
            });
        }

        function stopBackgroundMusic() {
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;
        }

        // Start the game
        resetGame();
        gameLoop();
    </script>
</body>
</html>